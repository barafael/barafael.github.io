<!DOCTYPE html>
<html lang="en" class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https:&#x2F;&#x2F;barafael.github.io">

    

    
    
    
    <title>
         Load-Bearing Oneliners in the Rust Standard Library
        
    </title>

        
            <meta property="og:title" content="Load-Bearing Oneliners in the Rust Standard Library" />
        
     

     
         
     

     
         
    

    
    

    
    
        <link href=https://barafael.github.io/fonts.css rel="stylesheet" />
    

    
    

    
    

    
    
        <script src=https://barafael.github.io/js/toc.js></script>
    

    
    

    

    
    <link rel="alternate" type="application/atom+xml" title="" href="https://barafael.github.io/atom.xml">


    
    
        <link rel="stylesheet" type="text/css" href=https://barafael.github.io/theme/light.css />
        <link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://barafael.github.io/theme/dark.css" />
    

    <!-- Set the correct theme in the script -->

    
        <script src=https://barafael.github.io/js/themetoggle.js></script>

        
            <script>setTheme(getSavedTheme());</script>
        
    


    <link rel="stylesheet" type="text/css" media="screen" href=https://barafael.github.io/main.css />

    

    <script defer src="https://barafael.github.io/search_index.en.js?h=8a2ff8418d4e423a245b"></script>
        <script defer src="https://barafael.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script></head>


<body>
    <div class="content">
        <header>
    <div class="main">
        
            <a href=https:&#x2F;&#x2F;barafael.github.io></a>
        


        <div class="socials">
            
            <a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;barafael&#x2F;" class="social">
                <img alt=github src=https://barafael.github.io/icons/social/github.svg>
            </a>
            
        </div>
    </div>

    <nav>
        
            <a href=https://barafael.github.io/posts style="margin-left: 0.25em">&#x2F;posts</a>
        

        
        <button
            id="search-button"
            class="search-button"
            title="$SHORTCUT to open search"
        >
            <img
                src="https://barafael.github.io/icons/search.svg"
                alt="Search"
                class="search-icon"
            >
        </button>

        <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
            <div id="modal-content">
                <h1 id="modalTitle" class="page-header">Search</h1>
                <div id="searchBar">
                    <input
                        id="searchInput"
                        role="combobox"
                        autocomplete="off"
                        spellcheck="false"
                        aria-expanded="false"
                        aria-controls="results-container"
                        placeholder="Search..."
                    />
                    <button
                        id="clear-search"
                        class="clear-button"
                        title="Clear search"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                            <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                        </svg>
                    </button>
                </div>
                <div id="results-container">
                    <div id="results-info">
                        <span id="zero_results" style="display: none;">No results</span>
                        <span id="one_result" style="display: none;">1 result</span>
                        <span id="many_results" style="display: none;">$NUMBER results</span>
                    </div>
                    <div id="results" role="listbox"></div>
                </div>
            </div>
        </div>
        

        
            <a id="dark-mode-toggle" onclick="toggleTheme(); event.preventDefault();" href="#">
                <img src=https://barafael.github.io/icons/sun.svg id="sun-icon" style="filter: invert(1);" alt="Light" />
                <img src=https://barafael.github.io/icons/moon.svg id="moon-icon" alt="Dark" />
            </a>

            <!-- Inititialize the theme toggle icons -->
            <script>updateItemToggleTheme()</script>
        
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <div class="page-header">
        Load-Bearing Oneliners in the Rust Standard Library<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>


                <div class="meta">
                    
                        Posted on <time>2022-09-14</time>
                    

                    

                    

                    
                        :: 256 Words
                    

                    
                    

                    
                    

                    

                </div>
        </div>

        

        
        
        
            <div class="toc-container">
                <h1 class="toc-title">Table of Contents</h1>
                <ul class="toc-list">
                    
                        <li>
                            <a href="https://barafael.github.io/posts/load-bearing-oneliners-in-the-rust-standard-library/#shared-references-are-copy-look-don-t-touch">Shared References are Copy (look don&#x27;t touch)</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://barafael.github.io/posts/load-bearing-oneliners-in-the-rust-standard-library/#drop-dead-gorgeous">Drop-Dead Gorgeous</a>
                            
                        </li>
                    
                </ul>
            </div>
        
        

        <section class="body">
            <p>The Rust language tries to be as minimal as possible.
Many crucial features and design decisions aren't compiler magic, instead they live in <code>core</code> or other parts of the standard library.
Here are some:</p>
<h1 id="shared-references-are-copy-look-don-t-touch">Shared References are <code>Copy</code> (look don't touch)<a class="zola-anchor" href="#shared-references-are-copy-look-don-t-touch" aria-label="Anchor link for: shared-references-are-copy-look-don-t-touch">ðŸ”—</a></h1>
<p>The <code>core::marker::Copy</code> trait marks a type which can be safely copied by simply copying its bits.
Think <code>bool</code>, <code>f64</code>, <code>Duration</code>, or <code>SocketAddr</code>.</p>
<p>A shared reference can obviously be copied. Owning a shared reference to a <code>T</code>, i.e., a <code>&amp;T</code>, allows us to copy it.</p>
<p>Here's the implementation of <code>core::marker::Copy</code> for shared references:</p>
<pre data-lang="rust" style="background-color:#ffffff;color:#000000;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#919191;">/// Shared references can be copied, but mutable references *cannot*!
</span><span>#[stable(feature </span><span style="color:#ff5600;">= </span><span style="color:#00a33f;">&quot;rust1&quot;</span><span>, since </span><span style="color:#ff5600;">= </span><span style="color:#00a33f;">&quot;1.0.0&quot;</span><span>)]
</span><span style="color:#ff5600;">impl</span><span>&lt;T: </span><span style="background-color:#990000;color:#ffffff;">?</span><span>Sized&gt; Copy for </span><span style="color:#ff5600;">&amp;</span><span>T {}
</span></code></pre>
<p>(lives at: https://doc.rust-lang.org/src/core/marker.rs.html#839)</p>
<p>This means, any shared reference to objects which aren't necessarily even <code>Sized</code> can be copied.
That's why we even can call a method taking <code>&amp;self</code> - copy the pointer to <code>self</code>, pass it to the method.</p>
<h1 id="drop-dead-gorgeous">Drop-Dead Gorgeous<a class="zola-anchor" href="#drop-dead-gorgeous" aria-label="Anchor link for: drop-dead-gorgeous">ðŸ”—</a></h1>
<pre data-lang="rust" style="background-color:#ffffff;color:#000000;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#919191;">/// --- Doc comment omitted ---
</span><span>#[inline]
</span><span>#[stable(feature </span><span style="color:#ff5600;">= </span><span style="color:#00a33f;">&quot;rust1&quot;</span><span>, since </span><span style="color:#ff5600;">= </span><span style="color:#00a33f;">&quot;1.0.0&quot;</span><span>)]
</span><span>#[cfg_attr(not(test), rustc_diagnostic_item </span><span style="color:#ff5600;">= </span><span style="color:#00a33f;">&quot;mem_drop&quot;</span><span>)]
</span><span style="color:#ff5600;">pub fn </span><span style="color:#21439c;">drop</span><span>&lt;T&gt;(_x: T) {}
</span></code></pre>
<p>The function <code>drop</code> is passed a <code>T</code> without any trait bounds.
What can it do with a <code>T</code>?
It cannot <code>Clone</code> it, cannot do <code>Add</code> or <code>Neg</code>, cannot even <code>Display</code>/<code>Debug</code>.
And it isn't returning a value of <code>T</code>!
There isn't much besides <code>{}</code> that would be a valid function body:</p>
<ul>
<li>Doing <code>unsafe</code> things to look at <code>T</code> (perilous, <code>T</code> might not be <code>Sized</code>)</li>
<li>Looping forever</li>
<li>Producing a value of type <code>Never</code> or <code>core::marker::Infallible</code> (<code>panic</code> and friends, or <code>std::process::exit</code>)</li>
<li>Taking a shared reference to <code>_x</code>, converting it to a usize, and storing it in a global <code>AtomicUsize</code>:</li>
</ul>
<pre data-lang="rust" style="background-color:#ffffff;color:#000000;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ff5600;">static</span><span> R: AtomicUsize </span><span style="color:#ff5600;">= </span><span>AtomicUsize::new(0);
</span><span>
</span><span style="color:#ff5600;">pub fn </span><span style="color:#21439c;">drop</span><span>&lt;T&gt;(_x: T) {
</span><span>    </span><span style="color:#ff5600;">let</span><span> r </span><span style="color:#ff5600;">= &amp;</span><span>_x;
</span><span>    R.</span><span style="color:#a535ae;">store</span><span>(r </span><span style="color:#ff5600;">as *const</span><span> T </span><span style="color:#ff5600;">as usize</span><span>, Ordering::SeqCst);
</span><span>}
</span></code></pre>
<p>Playground: https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=5e603039ddafeac0fdd599d78a59a13e</p>

        </section>
    </article>
</main>



        
            
        

        
    </div>
</body>

</html>
